<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Count it down</title>
    <link rel="stylesheet" href="style.css" type="text/css" media="screen" title="no title" charset="utf-8" />
  </head>
  <body>
    <div id="frame">
      <p class="credit"><a href="mailto:roy.kolak@gmail.com">Roy Kolak</a>, Copyright 2010</p>
      <div id="sections" class="sections">
        <div id="form" class="section">
          <div class="wrapper">
            <div class="left">
              <h1>Countdown to Zero</h1><h2>Your assignment is due, your friends are visiting, your trip is approaching<br/><br/> Count it down.</h2>
            </div>
            <form>
              <input type="text" id="title" placeholder="Clock title" />
              <p>The title of your countdown clock.</p>
              <input type="text" id="date" class="date" placeholder="Month, 19 2010 5:10pm"/>
              <p class="date_info">Your date will be parsed, be friendly!</p>
              <p class="parse_error error">Don't know that date. Maybe try another one?</p>
              <p class="diff_error error">That is too far in the future! Max countdown is 99 days.</p>
              <input type="submit" id="load" class="button" value="Start" />
              <p id="previous" class="previous">Psst! <strong id="previous_clock"></strong> is still running. <a href="#" id="resume" class="button small">Resume</a></p>
            </form>
            <div style="clear:both"></div>
          </div>
        </div>
        <div id="clock" class="section">
          <div class="wrapper">
            <audio id="tick" src="tick.mp3" loop="loop"></audio>
            <div class="controls">
              <a href="#" id="toggle_sound" class="sound">Toggle sound</a>
              <a href="#" id="back">New clock</a>
            </div>          
            <h1 id="clock_title"></h1>
            <div class="countdown_clock">
              <div class="clock">
                <div class="unit first">
                  <h3>Days</h3>
                  <div class="overlay">
                    <ol id="days">
                      <li class="digit digit_two">
                        <ol class="numbers">
                          <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>0</li>
                        </ol>
                      </li>
                      <li class="digit digit_one">
                        <ol class="numbers">
                          <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>0</li>
                        </ol>
                      </li>
                    </ol>
                  </div>
                </div>
                <div class="colon">:</div>
                <div class="unit">
                  <h3>Hours</h3>
                  <div class="overlay">
                    <ol id="hours">
                      <li class="digit digit_two">
                        <ol class="numbers">
                          <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>0</li>
                        </ol>
                      </li>
                      <li class="digit digit_one">
                        <ol class="numbers">
                          <li>0</li><li>1</li><li>2</li><li>0</li>
                        </ol>
                      </li>
                    </ol>
                  </div>
                </div>
                <div class="colon">:</div>
                <div class="unit">
                  <h3>Minutes</h3>
                  <div class="overlay">
                    <ol id="minutes">
                      <li class="digit digit_two">
                        <ol class="numbers">
                        <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>0</li>
                        </ol>
                      </li>
                      <li class="digit digit_one">
                        <ol class="numbers">
                          <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>0</li>
                        </ol>
                      </li>
                    </ol>
                  </div>
                </div>
                <div class="colon">:</div>
                <div class="unit last">
                  <h3>Seconds</h3>
                  <div class="overlay">
                    <ol id="seconds">
                      <li class="digit digit_two">
                        <ol class="numbers red">
                        <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>6</li><li>7</li><li>8</li><li>9</li><li>0</li>
                        </ol>
                      </li>
                      <li class="digit digit_one">
                        <ol class="numbers">
                          <li>0</li><li>1</li><li>2</li><li>3</li><li>4</li><li>5</li><li>0</li>
                        </ol>
                      </li>
                    </ol>
                  </div>
                </div>
                <div style="clear:both"></div>
              </div>
            </div>
            <h3 id="end_date"></h3>
            <div class="sharing">
              <h4>Share this countdown: <a href="#" id="url" class="url"></a></h4>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="scripts">
      <script src="javascripts/jquery.js"></script>
      <script src="javascripts/tested.js"></script>
      <script>
        (function($) {
          $.urlParam = function(name){
            var results = new RegExp('[\\?&]' + name + '=([^&#]*)').exec(window.location.href);
            return (results != null ? unescape(results[1]) : null);
          }

           audio = document.getElementsByTagName("audio")[0],
              db = localStorage,
              clock = null,
              load = new Load();

          if(db.sound == undefined)
            db.sound = "1";

          $('.wrapper').css({ paddingTop:$(window).height() / 4 });
          $('.section, #frame').height($(window).height());


          $('#load').click(function(ev) {
            ev.preventDefault();
            var title = $('#title').val() || $('#title').attr('placeholder');
            var date = $('#date').val() || $('#date').attr('placeholder');
            
            if(new DateValidator(date).validate()) {
              load.clock(title, date);
            }
          });
          
          $('#resume').click(function(ev) {
            ev.preventDefault();
            load.clock(db.title, db.date);
          });

          $('#back').click(function(ev) {
            ev.preventDefault();
            load.form();
          });

          $('#toggle_sound').click(function(ev) {
            ev.preventDefault();
            toggleSound();
          });
           
          load.form();
          
          function toggleSound() {
            db.sound = (db.sound == "1" ? "0" : "1");
            if(db.sound == "0") {
              audio.pause();
            }
          }
          
          function Load() {
            return {
              clock: function(title, date, duration_override) {
                var duration = 500;
                if(typeof(duration_override) != 'undefined') {
                  duration = duration_override;
                }
                $('#end_date').text(date.toLocaleString());
                $('#clock_title').text(title);
                var url = window.location.href.replace(window.location.search, '') + '?title=' + title + '&date=' + date;
                $('#url').text(url).attr('href', url);

                $('#sections').animate({top: -$('.section').height() }, {
                  duration:duration,
                  complete: function() {
                    clock = new Clock(title, date);
                    clock.start();
                  }
                });
              },
              form: function() {
                $('#form').css({ visibility: 'visible' });
                $('#sections').animate({top:0 });
                $('input[type=text]').val('');
                if($.urlParam('title') != null) {
                  $('#title').val($.urlParam('title'));
                  $('#date').val($.urlParam('date'));
                } else {
                  $('#date').attr('placeholder', "November 5, 2010 13:00");
                }
                $('.date_info').show();
                $('.error').hide();
                if(db.title != undefined) {
                  $('#previous_clock').text(db.title);
                  $('#previous').show();
                } else {
                  $('#previous').hide();
                }
                clock.stop()
                clock.reset();
              }
            }
          }
        })($);
      </script>
    </div>
  </body>
</html>
